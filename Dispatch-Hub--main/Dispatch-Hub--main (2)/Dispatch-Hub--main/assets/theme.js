(() => {
  const KEY = 'dispatchhub-theme';
  const root = document.documentElement;
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const varSets = { light: {'--bg':'#f7faff','--bg1':'#eef5ff','--bg2':'#dfeeff','--card':'#ffffff','--line':'#dbe3ef','--ink':'#0f172a','--muted':'#475569','--border':'#d0d7de','--primary':'#2563eb','--accent':'#2563eb','--accent2':'#0ea5a0','--good':'#16a34a','--warn':'#d97706','--danger':'#dc2626'}, dark: {'--bg':'#0b1020','--bg1':'#0f172a','--bg2':'#111827','--card':'#111827','--line':'#334155','--ink':'#e5e7eb','--muted':'#94a3b8','--border':'#334155','--primary':'#60a5fa','--accent':'#60a5fa','--accent2':'#22c55e','--good':'#22c55e','--warn':'#f59e0b','--danger':'#ef4444'} };
  function getInitialTheme(){ try{ const s=localStorage.getItem(KEY); if(s==='light'||s==='dark') return s; }catch(e){} return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark'; }
  function applyVars(theme){ const vars=varSets[theme]||{}; Object.keys(vars).forEach(k=>root.style.setProperty(k, vars[k])); root.style.colorScheme = theme === 'light' ? 'light' : 'dark'; }
  function applyTheme(theme){ root.setAttribute('data-theme', theme); applyVars(theme); try{localStorage.setItem(KEY, theme);}catch(e){} const btn=document.getElementById('dhThemeToggle'); if(btn){ btn.innerHTML = `<span class="ico">${theme==='light'?'üåô':'‚òÄÔ∏è'}</span>${theme==='light'?'Dark':'Light'}`; btn.title = `Switch to ${theme==='light'?'dark':'light'} mode`; btn.setAttribute('aria-label', btn.title);} }
  function ensureButton(){ if(!document.body || document.getElementById('dhThemeToggle')) return; const btn=document.createElement('button'); btn.id='dhThemeToggle'; btn.type='button'; btn.onclick=()=>applyTheme((root.getAttribute('data-theme')==='light')?'dark':'light'); document.body.appendChild(btn); applyTheme(root.getAttribute('data-theme')||getInitialTheme()); }
  function markCards(){ const sel='.card,.panel,.tool-card,.tile,.widget,.glass,.section,.box,.result-card,.list-card,.table-wrap,.toolbar,.sidebar,.content,.shell,.container,.wrap,.app,.hero,.modal,.dialog'; let d=0; document.querySelectorAll(sel).forEach(el=>{ if(el.dataset.dhFxCard) return; el.dataset.dhFxCard='1'; el.classList.add('dh-fx-card','dh-reveal'); el.style.setProperty('--dh-delay', `${Math.min(d,320)}ms`); d+=20; }); }
  function pointerGlow(){ if(document.body && !document.body.dataset.dhPointerGlow){ document.body.dataset.dhPointerGlow='1'; document.addEventListener('pointermove', e=>{ document.body.style.setProperty('--dh-mx', `${(e.clientX/Math.max(window.innerWidth,1))*100}%`); document.body.style.setProperty('--dh-my', `${(e.clientY/Math.max(window.innerHeight,1))*100}%`); }, {passive:true}); } document.querySelectorAll('.dh-fx-card').forEach(card=>{ if(card.dataset.dhPointerBound) return; card.dataset.dhPointerBound='1'; card.addEventListener('pointermove', e=>{ const r=card.getBoundingClientRect(); if(!r.width||!r.height) return; card.style.setProperty('--mx', `${((e.clientX-r.left)/r.width)*100}%`); card.style.setProperty('--my', `${((e.clientY-r.top)/r.height)*100}%`); }); }); }
  function revealOnScroll(){ const els=document.querySelectorAll('.dh-reveal'); if(prefersReduced || !('IntersectionObserver' in window)){ els.forEach(el=>el.classList.add('is-visible')); return; } if(window.__dhRevealObserver){ els.forEach(el=>{ if(!el.classList.contains('is-visible')) window.__dhRevealObserver.observe(el);}); return; } const obs = new IntersectionObserver(entries=>{ entries.forEach(ent=>{ if(ent.isIntersecting){ ent.target.classList.add('is-visible'); obs.unobserve(ent.target);} }); }, {threshold:0.08, rootMargin:'0px 0px -6% 0px'}); window.__dhRevealObserver=obs; els.forEach(el=>obs.observe(el)); }
  function enhanceButtons(){ document.querySelectorAll('button,.btn,a.btn,input[type="button"],input[type="submit"],[role="button"]').forEach(btn=>{ if(btn.dataset.dhBtn) return; btn.dataset.dhBtn='1'; btn.addEventListener('click', e=>{ if(prefersReduced) return; try{ const r=btn.getBoundingClientRect(); const s=Math.max(r.width,r.height)*1.2; const sp=document.createElement('span'); sp.style.cssText='position:absolute;border-radius:999px;pointer-events:none;background:rgba(255,255,255,.25);transform:scale(0);opacity:.7;transition:transform .45s ease, opacity .55s ease;'; sp.style.width=sp.style.height=`${s}px`; sp.style.left=`${e.clientX-r.left-s/2}px`; sp.style.top=`${e.clientY-r.top-s/2}px`; btn.appendChild(sp); requestAnimationFrame(()=>{ sp.style.transform='scale(1)'; sp.style.opacity='0'; }); setTimeout(()=>sp.remove(),650);}catch(_){} }); }); }
  function enhanceTables(){ document.querySelectorAll('table').forEach(t=>{ if(t.dataset.dhTable) return; t.dataset.dhTable='1'; t.classList.add('dh-table');}); }
  function boot(){ if(!document.body) return; if(!document.body.dataset.dhEnhanced) document.body.dataset.dhEnhanced='1'; markCards(); pointerGlow(); revealOnScroll(); enhanceButtons(); enhanceTables(); }
  applyTheme(root.getAttribute('data-theme')||getInitialTheme());
  function ready(){ ensureButton(); boot(); if(!window.__dhMutationObserver && 'MutationObserver' in window){ const mo = new MutationObserver(ms=>{ if(ms.some(m=>m.addedNodes && m.addedNodes.length)) boot(); }); mo.observe(document.body,{childList:true,subtree:true}); window.__dhMutationObserver=mo; } }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ready, {once:true}); else ready();
})();
